<template>
    <LoadingGroup :pending="pending" :error="error">
        <section class="detail-top">
            <n-image :src="data.cover" object-fit="cover" class="image" />
            <div class="info">
                <div class="flex flex-col items-start">
                    <div class="flex items-center">
                        <span class="text-xl mr-2">{{ data.title }}</span>
                        <FavaBtn :isfava="data.isfava" :goods_id="data.id" :type="type" />
                    </div>
                    <p class="my-2 text-xs text-gray-400">{{ subTitle }}</p>
                    <!-- 领取优惠券 -->
                    <CouponModal />
                    <div v-if="!data.isbuy">
                        <Price :value="data.price" class="text-xl" />
                        <Price :value="data.t_price" through class="ml-1 text-xs" />
                    </div>
                </div>

                <div class="mt-auto" v-if="!data.isbuy">
                    <n-button type="primary" :loading="loading" @click="buy">立即学习</n-button>
                </div>
            </div>
        </section>

        <n-grid :x-gap="20">
            <n-grid-item :span="18">
                <section class="detail-bottom">
                    <UiTab class="border-b">
                        <UiTabItem :active="tab == item.value" v-for="(item, index) in tabs" :key="index"
                            @click="changeTab(item.value)">{{ item.label }}</UiTabItem>
                    </UiTab>
                    <div v-if="tab == 'content'" class="content"
                        v-html="(data.type == 'media' && data.isbuy) ? data.content : data.try"></div>

                    <DetailMenu v-else>
                        <DetailMenuItem v-for="(item, index) in data.column_courses" :key="index" :item="item"
                            :index="index" @click="learn(item)" />

                        <Empty v-if="data.column_courses.length == 0" desc="暂无目录" />
                    </DetailMenu>

                </section>
            </n-grid-item>
            <n-grid-item :span="6">
                <HotCourseList />
            </n-grid-item>
        </n-grid>
    </LoadingGroup>
</template>
<script setup>
import {
    NButton,
    NGrid,
    NGridItem,
    NImage,
    createDiscreteApi
} from "naive-ui";
const route = useRoute()
const { id, type } = route.params

const {
    tabs,
    tab,
    changeTab
} = useInitDetailTabs(type)

// 获取请求参数
const query = useRequestQuery()

const {
    data,
    error,
    pending,
    refresh
} = await useReadDetailApi(type, query)

const title = computed(() => !pending.value ? data.value?.title : "详情页")

useHead({ title })

const o = {
    media: "图文",
    video: "视频",
    audio: "音频"
}

const subTitle = computed(() => {
    let pre = ""
    if (type === "course") {
        pre = `【${o[data.value.type]}】`
    }
    return `${pre}${data.value.sub_count}人学过`
})


// 购买学习
const loading = ref(false)
const buy = () => {
    useHasAuth(async () => {
        // 免费学习
        if (data.value.price == 0) {
            loading.value = true
            let {
                error: learnError
            } = await useLearnApi({
                goods_id: data.value.id,
                type
            })

            loading.value = false

            // 请求成功，刷新数据
            if (!learnError.value) refresh()

            return
        }
    })
}

// 点击菜单
const learn = (item) => {
    useHasAuth(() => {
        const { message } = createDiscreteApi(["message"])
        if (type == "column" && item.price != 0 && !data.value.isbuy) {
            return message.error("请先购买该专栏")
        }
        // 跳转
        let url = ""
        if (type == "column") {
            url = `/detail/course/${item.id}?column_id=${data.value.id}`
        }
        navigateTo(url)
    })
}

// 获取query
function useRequestQuery() {
    const {
        column_id
    } = route.query

    let query = {
        id
    }
    if (column_id) {
        query.column_id = column_id
    }
    return query
}

// 初始化tab
function useInitDetailTabs(t) {
    const tabs = computed(() => {
        let ts = [{
            label: "详情",
            value: "content"
        }]

        if (t == "column" || t == "book") {
            ts.push({
                label: "目录",
                value: "menu"
            })
        }

        return ts
    })

    const tab = ref("content")

    const changeTab = (e) => tab.value = e

    return {
        tabs,
        tab,
        changeTab
    }
}

</script>
<style>
.detail-top {
    @apply rounded bg-white flex p-5 my-5;
}

.detail-top .image {
    @apply rounded w-[340px] h-[200px] mr-5;
}

.detail-top .info {
    @apply flex-1 flex flex-col py-2;
}

.detail-bottom {
    @apply bg-white rounded mb-5;
}

.detail-bottom .content {
    @apply px-5 pb-5;
}

.detail-bottom .content img {
    max-width: 100% !important;
}
</style>